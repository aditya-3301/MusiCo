<!DOCTYPE html>
<html lang="en">
<link rel="stylesheet" href="style.css">
<head>
    <title>MusiCo - Ad-Free Streaming</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/Draggable.min.js"></script>
</head>
<body>
    <div id="particles-js"></div>
    <div class="player-bar">
        <div class="custom-controls">
            <button id="prev-btn">⏮</button>
            <button id="play-btn" class="glass-tint-black" onclick="toggle_play()">▶</button>
            <button id="next-btn" class="glass-tint-muted">⏭</button>
            
            <span id="current-time">0:00</span>
            <input type="range" id="progress-bar" value="0" max="100">
            <span id="total-time">0:00</span>
        </div>

        <div id="now-playing">
            <div id="np-title">PLAY SOMETHING to show it here idiot</div>
            <div id="np-artist"></div>
        </div>
        <audio id="audio-player"></audio>
    </div>

    <div class="layout">
        <nav class="sidebar">
            <h2>Welcome, Aditya</h2>
            <input type="text" id="search-box" placeholder="Search" onkeyup="filter_songs()">
        </nav>
        <main class="content">
            <h1>All Songs in folder: Main</h1>
            <div id="track-list">loading tracks...</div>
        </main>
    </div>
    <script>
        const user = prompt("username:");
        const pass = prompt("password:");

        async function load_tracks() {
            const res = await fetch(`/api/playlist?user=${user}&pass=${pass}`);
            if (!res.ok) return document.getElementById('track-list').innerText = "wrong login.";
            
            const list = await res.json();
            const container = document.getElementById('track-list');
            container.innerHTML = '';

            list.forEach(raw_item => {
                let artist = "unknown artist";
                let title = raw_item;
                
                if (raw_item.includes('-')) {
                    const parts = raw_item.split('-');
                    artist = parts[0].trim();
                    title = parts.slice(1).join('-').trim(); 
                }

                const div = document.createElement('div');
                div.className = 'track-item';
                div.innerHTML = `<div class="track-title">${title}</div><div class="track-artist">${artist}</div>`;
                div.onclick = () => play_song(raw_item, title, artist);
                container.appendChild(div);
            });
        }

        function play_song(raw_name, title, artist) {
            document.getElementById('np-title').innerText = title;
            document.getElementById('np-artist').innerText = artist;
            const player = document.getElementById('audio-player');
            player.src = `/stream?filename=${encodeURIComponent(raw_name)}&user=${user}&pass=${pass}`;
            player.play();
        }

        function filter_songs() {
            const query = document.getElementById('search-box').value.toLowerCase();
            const tracks = document.querySelectorAll('.track-item');
            tracks.forEach(track => {
                const text = track.innerText.toLowerCase();
                track.style.display = text.includes(query) ? 'flex' : 'none';
            });
        }

        const audio = document.getElementById('audio-player');
        const play_btn = document.getElementById('play-btn');
        const progress = document.getElementById('progress-bar');
        const current_time_text = document.getElementById('current-time');
        const total_time_text = document.getElementById('total-time');

        function toggle_play() {
            if (audio.paused) audio.play();
            else audio.pause();
        }

        audio.addEventListener('play', () => play_btn.innerText = '⏸');
        audio.addEventListener('pause', () => play_btn.innerText = '▶');

        audio.addEventListener('timeupdate', () => {
            if (audio.duration) {
                progress.value = (audio.currentTime / audio.duration) * 100;
                current_time_text.innerText = format_time(audio.currentTime);
                total_time_text.innerText = format_time(audio.duration);
            }
        });

        progress.addEventListener('input', () => {
            audio.currentTime = (progress.value / 100) * audio.duration;
        });

        function format_time(seconds) {
            const min = Math.floor(seconds / 60);
            const sec = Math.floor(seconds % 60);
            return `${min}:${sec < 10 ? '0' : ''}${sec}`;
        }

        load_tracks();
    </script>
    <script src="particles.js"></script>
    <script>
        // This fires up the local file you just created
        particlesJS("particles-js", {
            "particles": {
                "number": { "value": 80 },
                "color": { "value": "#ffffff" },
                "shape": { "type": "circle" },
                "opacity": { "value": 0.5 },
                "size": { "value": 3 },
                "line_linked": { "enable": true, "distance": 150, "color": "#ffffff", "opacity": 0.3, "width": 1 },
                "move": { "enable": true, "speed": 1.5 }
            },
            "interactivity": {
                "events": {
                    "onhover": { "enable": true, "mode": "grab" }
                }
            }
        });
        // --- LIQUID GLASS DRAGGABLE ---
        gsap.registerPlugin(Draggable);

        Draggable.create(".custom-controls", {
            type: "x, y",
            // When you let go, snap back with a liquid bounce
            onRelease: function () {
                gsap.to(this.target, {
                    x: 0,
                    y: 0,
                    duration: 1.5,
                    ease: "elastic.out(1,0.3)"
                });
            }
        });
    </script>
    <svg style="display: none" xmlns="http://www.w3.org/2000/svg">
      <filter id="glass-blur" x="0" y="0" width="100%" height="100%" filterUnits="objectBoundingBox">
        <feTurbulence type="fractalNoise" baseFrequency="0.003 0.007" numOctaves="1" result="turbulence" />
        <feDisplacementMap in="SourceGraphic" in2="turbulence" scale="119" xChannelSelector="R" yChannelSelector="G" />
      </filter>
    </svg>
</body>
</html>