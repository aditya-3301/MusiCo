<!DOCTYPE html>
<html lang="en">
<link rel="stylesheet" href="style.css">
<head>
    <title>MusiCo - Ad-Free Streaming</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/Draggable.min.js"></script>
</head>
<body>
    <div id="particles-js"></div>
    
    <div class="player-bar">
        
        <div class="custom-controls">
            <button id="shuffle-btn" class="glass-tint-muted" onclick="toggle_shuffle()">üîÄ</button>
            <button id="prev-btn">‚èÆ</button>
            <button id="play-btn" class="glass-tint-black" onclick="toggle_play()">‚ñ∂</button>
            <button id="next-btn" class="glass-tint-muted">‚è≠</button>
        </div>
        
        <div class="progress-container">
            <span id="current-time">0:00</span>
            <input type="range" id="progress-bar" value="0" max="100">
            <span id="total-time">0:00</span>
        </div>

        <div id="now-playing">
            <div id="np-title">PLAY SOMETHING to show it here idiot</div>
            <div id="np-artist"></div>
        </div>
        <audio id="audio-player"></audio>
    </div>

    <div class="layout">
        <nav class="sidebar">
            <h2>Welcome, Aditya</h2>
            <input type="text" id="search-box" placeholder="Search" onkeyup="filter_songs()">
        </nav>
        <main class="content">
            <h1>All Songs in folder: mega/main</h1>
            <div id="track-list">loading tracks...</div>
        </main>
    </div>
    <script>
        const user = prompt("username:");
        const pass = prompt("password:");

        let current_playlist = [];
        let current_track_index = -1;
        let is_shuffle = false; // <-- NEW: Tracks if shuffle is on


        // --- NEW: Toggle shuffle state and update button colors ---
        function toggle_shuffle() {
            is_shuffle = !is_shuffle;
            const btn = document.getElementById('shuffle-btn');
            
            if (is_shuffle) {
                // Solid white background when active
                btn.classList.remove('glass-tint-muted');
                btn.style.backgroundColor = 'white';
                btn.style.color = 'black'; // Keep icon visible against white
            } else {
                // Revert to normal glass state when inactive
                btn.style.backgroundColor = '';
                btn.style.color = '';
                btn.classList.add('glass-tint-muted');
            }
        }

        
        
        async function load_tracks() {
            const res = await fetch(`/api/playlist?user=${user}&pass=${pass}`);
            if (!res.ok) {
                const error_msg = await res.text();
                console.error("Server Error:", error_msg);
                document.getElementById('track-list').innerText = `Error ${res.status}: ${error_msg}`;
                return;
            }
            
            const list = await res.json();
            current_playlist = list; // <-- NEW: Store the playlist globally
            
            const container = document.getElementById('track-list');
            container.innerHTML = '';

            list.forEach(raw_item => {
                let artist = "artist is in Songname itself buddy.";
                let title = raw_item;
                
                if (raw_item.includes('-')) {
                    const parts = raw_item.split('-');
                    artist = parts[0].trim();
                    title = parts.slice(1).join('-').trim(); 
                }

                const div = document.createElement('div');
                div.className = 'track-item';
                div.innerHTML = `<div class="track-title">${title}</div><div class="track-artist">${artist}</div>`;
                div.onclick = () => play_song(raw_item, title, artist);
                container.appendChild(div);
            });
        }

        function play_song(raw_name, title, artist) {
            current_track_index = current_playlist.indexOf(raw_name); // <-- NEW: Track the current song index
            
            document.getElementById('np-title').innerText = title;
            document.getElementById('np-artist').innerText = artist;
            const player = document.getElementById('audio-player');
            player.src = `/stream?filename=${encodeURIComponent(raw_name)}&user=${user}&pass=${pass}`;
            player.play();
        }

        function filter_songs() {
            const query = document.getElementById('search-box').value.toLowerCase();
            const tracks = document.querySelectorAll('.track-item');
            tracks.forEach(track => {
                const text = track.innerText.toLowerCase();
                track.style.display = text.includes(query) ? 'flex' : 'none';
            });
        }

        const audio = document.getElementById('audio-player');
        const play_btn = document.getElementById('play-btn');
        const progress = document.getElementById('progress-bar');
        const current_time_text = document.getElementById('current-time');
        const total_time_text = document.getElementById('total-time');

        
        function play_next() {
            if (current_playlist.length === 0) return;
            
            if (is_shuffle && current_playlist.length > 1) {
                // Pick a random track that IS NOT the currently playing track
                let random_index = current_track_index;
                while (random_index === current_track_index) {
                    random_index = Math.floor(Math.random() * current_playlist.length);
                }
                current_track_index = random_index;
            } else {
                // Normal sequential play
                current_track_index++;
                if (current_track_index >= current_playlist.length) current_track_index = 0; // Loop back to start
            }
            
            load_track_from_index(current_track_index);
        }

        function play_prev() {
            if (current_playlist.length === 0) return;
            current_track_index--;
            if (current_track_index < 0) current_track_index = current_playlist.length - 1; // Loop to end
            
            load_track_from_index(current_track_index);
        }

        function load_track_from_index(index) {
            const raw_name = current_playlist[index];
            let artist = "unknown artist";
            let title = raw_name;
            
            if (raw_name.includes('-')) {
                const parts = raw_name.split('-');
                artist = parts[0].trim();
                title = parts.slice(1).join('-').trim(); 
            }
            play_song(raw_name, title, artist);
        }

        // Attach logic to the HTML buttons
        document.getElementById('next-btn').addEventListener('click', play_next);
        document.getElementById('prev-btn').addEventListener('click', play_prev);

        // Auto-play the next song when the current one finishes
        audio.addEventListener('ended', play_next);

        

        function toggle_play() {
            if (audio.paused) audio.play();
            else audio.pause();
        }

        audio.addEventListener('play', () => play_btn.innerText = '‚è∏');
        audio.addEventListener('pause', () => play_btn.innerText = '‚ñ∂');

        // Unified Error Handling: Auto-skip corrupted files or failed streams
        audio.addEventListener('error', () => {
            console.error("Playback error: File corrupted or MEGA stream failed.");
            
            // Update UI to show error
            document.getElementById('np-title').innerText = "‚ö†Ô∏è Stream error / Corrupted file. Skipping...";
            play_btn.innerText = '‚ñ∂'; 
            
            // Wait 1.5 seconds so the user sees the message, then auto-skip
            setTimeout(() => {
                play_next();
            }, 1500);
        });

        // Add a buffering indicator when the stream is stalled or loading
        let current_track_title = ""; // Store title to restore it after buffering
        
        audio.addEventListener('waiting', () => {
            current_track_title = document.getElementById('np-title').innerText;
            if (current_track_title !== "STREAM ERROR - Try again") {
                document.getElementById('np-title').innerText = "Buffering stream...";
            }
        });

        audio.addEventListener('playing', () => {
            if (current_track_title && document.getElementById('np-title').innerText === "Buffering stream...") {
                document.getElementById('np-title').innerText = current_track_title;
            }
        });
        
        audio.addEventListener('timeupdate', () => {
            if (audio.duration) {
                progress.value = (audio.currentTime / audio.duration) * 100;
                current_time_text.innerText = format_time(audio.currentTime);
                total_time_text.innerText = format_time(audio.duration);
            }
        });

        progress.addEventListener('input', () => {
            audio.currentTime = (progress.value / 100) * audio.duration;
        });

        function format_time(seconds) {
            const min = Math.floor(seconds / 60);
            const sec = Math.floor(seconds % 60);
            return `${min}:${sec < 10 ? '0' : ''}${sec}`;
        }

        load_tracks();
    </script>
    <script src="particles.js"></script>
    <script>
        // This fires up the local file you just created
        particlesJS("particles-js", {
            "particles": {
                "number": { "value": 80 },
                "color": { "value": "#ffffff" },
                "shape": { "type": "circle" },
                "opacity": { "value": 0.5 },
                "size": { "value": 3 },
                "line_linked": { "enable": true, "distance": 150, "color": "#ffffff", "opacity": 0.3, "width": 1 },
                "move": { "enable": true, "speed": 1.5 }
            },
            "interactivity": {
                "events": {
                    "onhover": { "enable": true, "mode": "grab" }
                }
            }
        });
        // --- LIQUID GLASS DRAGGABLE ---
        gsap.registerPlugin(Draggable);

        // --- LIQUID GLASS DRAGGABLE ---
        gsap.registerPlugin(Draggable);

        Draggable.create(".custom-controls", {
            type: "x, y",
            
            // --- THE ANDROID FIX ---
            dragClickables: false, // Ensures buttons can be clicked normally
            minimumMovement: 10,   // Prevents slight finger wobbles from cancelling the tap
            // -----------------------

            // When you let go, snap back with a liquid bounce
            onRelease: function () {
                gsap.to(this.target, {
                    x: 0,
                    y: 0,
                    duration: 1.5,
                    ease: "elastic.out(1,0.3)"
                });
            }
        });
    </script>
    
<svg style="display: none" xmlns="http://www.w3.org/2000/svg">
      
      <filter id="glass-blur-player" x="0" y="0" width="100%" height="100%" filterUnits="objectBoundingBox">
        <feTurbulence type="fractalNoise" baseFrequency="0.003 0.007" numOctaves="1" result="turbulence" />
        <feDisplacementMap in="SourceGraphic" in2="turbulence" scale="200" xChannelSelector="R" yChannelSelector="G" />
      </filter>

      <filter id="glass-blur-track" x="0" y="0" width="100%" height="100%" filterUnits="objectBoundingBox">
        <feTurbulence type="fractalNoise" baseFrequency="0.003 0.007" numOctaves="1" result="turbulence" />
        <feDisplacementMap in="SourceGraphic" in2="turbulence" scale="130" xChannelSelector="R" yChannelSelector="G" />
      </filter>

    </svg>

</body>
</html>